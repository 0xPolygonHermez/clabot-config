name: CLA Digital Signature Verification

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'GitHub username to verify'
        required: true
        type: string
      
jobs:
  verify-signature:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Verify CLA signature
      run: |
        USERNAME="${{ github.event.inputs.username }}"
        SIGNATURE_FILE="signatures/${USERNAME}_signature.json"
        
        if [ ! -f "$SIGNATURE_FILE" ]; then
          echo "❌ No signature record found for $USERNAME"
          exit 1
        fi
        
        echo "🔍 Verifying CLA signature for $USERNAME"
        echo "=================================================="
        
        # Extract signature data
        GITHUB_USER_ID=$(jq -r '.github_user_id' "$SIGNATURE_FILE")
        SIGNATURE_TIMESTAMP=$(jq -r '.signature_timestamp' "$SIGNATURE_FILE")
        SIGNATURE_HASH=$(jq -r '.signature_hash' "$SIGNATURE_FILE")
        SIGNATURE_METHOD=$(jq -r '.signature_method' "$SIGNATURE_FILE")
        CLA_VERSION=$(jq -r '.cla_version' "$SIGNATURE_FILE")
        
        echo "📋 Signature Details:"
        echo "   Username: $USERNAME"
        echo "   GitHub ID: $GITHUB_USER_ID"
        echo "   Timestamp: $SIGNATURE_TIMESTAMP"
        echo "   Method: $SIGNATURE_METHOD"
        echo "   CLA Version: $CLA_VERSION"
        echo "   Hash: $SIGNATURE_HASH"
        
        # Verify user still exists in contributors list
        if jq -e --arg user "$USERNAME" '.contributors | index($user)' .clabot > /dev/null; then
          echo "✅ User is in current CLA contributors list"
        else
          echo "⚠️  User NOT in current CLA contributors list"
        fi
        
        # Verify git history contains the signature
        if git log --grep="$USERNAME" --oneline | grep -q "CLA contributors"; then
          echo "✅ Signature commit found in git history"
        else
          echo "⚠️  Signature commit not found in git history"
        fi
        
        # Verify hash integrity (basic check)
        EXPECTED_PATTERN="${USERNAME}-.*"
        if [[ $SIGNATURE_HASH =~ ^[a-f0-9]{64}$ ]]; then
          echo "✅ Signature hash format valid (SHA256)"
        else
          echo "❌ Invalid signature hash format"
        fi
        
        echo ""
        echo "🎯 Verification Summary:"
        echo "========================"
        jq '.' "$SIGNATURE_FILE"
        
    - name: Generate verification report
      run: |
        USERNAME="${{ github.event.inputs.username }}"
        REPORT_FILE="verification_${USERNAME}_$(date +%Y%m%d_%H%M%S).json"
        
        cat > "$REPORT_FILE" << EOF
        {
          "verification_timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "verified_by": "${{ github.actor }}",
          "username": "$USERNAME",
          "signature_exists": $([ -f "signatures/${USERNAME}_signature.json" ] && echo "true" || echo "false"),
          "in_contributors_list": $(jq --arg user "$USERNAME" 'if (.contributors | index($user)) then true else false end' .clabot),
          "verification_hash": "$(echo -n "$USERNAME-$(date -u)" | sha256sum | cut -d' ' -f1)"
        }
        EOF
        
        echo "📊 Verification report saved: $REPORT_FILE"
        cat "$REPORT_FILE"
        
    - name: Upload verification report
      uses: actions/upload-artifact@v4
      with:
        name: cla-verification-${{ github.event.inputs.username }}-${{ github.run_number }}
        path: verification_*.json
        retention-days: 90
